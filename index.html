<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Totem.GitHub.io by totem</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/main.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>

      <header>
        <h1>Totem.GitHub.io</h1>
        <p>Totem documentation, issues, guides.</p>
      </header>

      <div id="banner">
        <span id="logo"></span>

        <a href="https://github.com/totem" class="button fork"><strong>View On GitHub</strong></a>
      </div><!-- end banner -->

    <div class="wrapper">
      <nav>
        <ul></ul>
      </nav>
      <section>
        <h1>
<a id="what-is-totem-" class="anchor" href="#what-is-totem-" aria-hidden="true"><span class="octicon octicon-link"></span></a>What is totem ?</h1>

<p>Totem is continous delivery pipline tool which is aimed in simplifying delivery of the code for stateless application to any environment. Under the hood, it utilizes containerization tools and technology (<a href="https://www.docker.com">Docker</a>).</p>

<p>It was specifically designed for micro services/frameworks by utilizing practices and patterns that are used for deploying the same (<a href="http://jeffkreeftmeijer.com/2010/why-arent-you-using-git-flow/">gitflow</a>, service discovery, containerization, centralized logging, and more...)</p>

<h1>
<a id="reporting-issues" class="anchor" href="#reporting-issues" aria-hidden="true"><span class="octicon octicon-link"></span></a>Reporting Issues</h1>

<p>Issues can be reported at :
<a href="https://github.com/totem/totem.github.io/issues">https://github.com/totem/totem.github.io/issues</a>
Issues may include help requests, bugs or feature requests. </p>

<h1>
<a id="architecture" class="anchor" href="#architecture" aria-hidden="true"><span class="octicon octicon-link"></span></a>Architecture</h1>

<h2>
<a id="high-level-flow" class="anchor" href="#high-level-flow" aria-hidden="true"><span class="octicon octicon-link"></span></a>High Level flow</h2>

<p><img src="http://www.gliffy.com/go/publish/image/7041599/L.png" alt=""></p>

<ul>
<li>Developer commits file to git and pushes the changes to scm (e.g: <a href="https://github.com/">github</a>)</li>
<li>Github triggers webhooks for push events to image builder tool e.g: <a href="https://github.com/totem/docker-image-factory">"Image Factory"</a> and CI tools like <a href="https://travis-ci.org">Travis</a>, <a href="https://www.atlassian.com/software/bamboo">Bamboo</a>.</li>
<li>Once travis  (or any other ci) build  and image builder build finishes it notifies <a href="https://github.com/totem/cluster-orchestrator">orchestrator</a> about the status using post build webhooks.</li>
<li>Orchestrator on receving any hook, loads/caches the configuration for the build (totem.yml). This file is loaded from <a href="http://aws.amazon.com/s3/">Amazon S3</a> (or <a href="https://coreos.com/using-coreos/etcd/">etcd</a>).</li>
<li>Orchestrator on receving all the hooks with status as "success", it invokes deployer api to deploy the built image to <a href="https://coreos.com/">CoreOS cluster</a>.</li>
<li>Deployer creates <a href="https://coreos.com/using-coreos/clustering">fleet</a> unit files for the application and submits the job to fleet daemon (running on CoreOS cluster). On successul deploy, deployer promotes the current deployment by updating the yoda proxy configuration stored in etcd.</li>
</ul>

<h2>
<a id="application-deployment" class="anchor" href="#application-deployment" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="deployment.md">Application Deployment</a>
</h2>

<p>Here is a sample application deployed using Totem in Amazon EC2 infrastructure.
<img src="http://www.gliffy.com/go/publish/image/7051027/L.png" alt=""></p>

<h2>
<a id="components" class="anchor" href="#components" aria-hidden="true"><span class="octicon octicon-link"></span></a>Components</h2>

<p>The "Totem Ecosystem" comprises of several components each responsible to perform discrete set of jobs. One may choose to deploy some/all of the components in Totem , depending upon his/her needs. It is also possible to have
additional components for deploying applications using Totem (for e.g.: sidekicks for registering with SkyDNS)</p>

<ul>
<li>
<a href="https://github.com/totem/docker-image-factory"><strong>Image Factory</strong></a>: Responsible for building docker images using "Dockerfile" and push these to a central registry
(e.g: Quay)</li>
<li>
<a href="https://github.com/totem/cluster-orchestrator"><strong>Orchestrator</strong></a>: Responsible for consuming hooks from different services (like Travis, Image Factory etc) and creating deployment requests to <em>Deployers</em> for configured clusters.</li>
<li>
<a href="https://github.com/totem/cluster-deployer"><strong>Deployer</strong></a>: Schedules the deployment to a cluster (currently CoreOS) and sets up the proxy hosts/listeners.</li>
<li>
<a href="https://github.com/totem/yoda-proxy"><strong>Yoda Proxy</strong></a>: Dynamic Haproxy backed by etcd.</li>
<li>
<a href="https://github.com/totem/yoda-discover"><strong>Yoda Discover</strong></a>: Acts as side kick for registering application unit to yoda proxy using etcd as backing store.
Also provides ability to register yoda hosts to etcd.</li>
<li>
<a href="https://github.com/totem/yoda-discover"><strong>Yoda Route53</strong></a>: Registers the yoda hosts with Amazon Route 53 for DNS based load balancing for hosts.</li>
<li>
<a href="https://github.com/totem/fleet-templates"><strong>Fleet Templates</strong></a>: Jinja based fleet unit files that gets deployed to CoreOS cluster. Some of the default templates are already provided, but one may choose to have his/her own custom templates.</li>
</ul>

<h1>
<a id="totem-events" class="anchor" href="#totem-events" aria-hidden="true"><span class="octicon octicon-link"></span></a>Totem Events</h1>

<h2>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview</h2>

<p>The different totem components (deployer, orchestrator) publishes events to elasticsearch (if enabled).  Here is an example event: </p>

<div class="highlight highlight-json"><pre>{
    <span class="pl-s"><span class="pl-pds">"</span>date<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>2015-04-01T06:25:06.389047<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>type<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>NEW_JOB<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>component<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>orchestrator<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>meta-info<span class="pl-pds">"</span></span>: {
      <span class="pl-s"><span class="pl-pds">"</span>git<span class="pl-pds">"</span></span>: {
        <span class="pl-s"><span class="pl-pds">"</span>owner<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>meltmedia<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>repo<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>totem-demo<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>ref<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>master<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>commit<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>87c4419d3e278036055ca2cd022583e0397d3a5d<span class="pl-pds">"</span></span>
      },
      <span class="pl-s"><span class="pl-pds">"</span>job-id<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>9be083a1-9fc2-48b3-83bc-e11c8bbab305<span class="pl-pds">"</span></span>
    },
    <span class="pl-s"><span class="pl-pds">"</span>details<span class="pl-pds">"</span></span>: {
    }
}</pre></div>

<h2>
<a id="event-fields" class="anchor" href="#event-fields" aria-hidden="true"><span class="octicon octicon-link"></span></a>Event fields</h2>

<p>Every event consists of following fields:</p>

<ul>
<li>
<em>date</em>:  Timestamp for event</li>
<li>
<em>type</em>:  Event type</li>
<li>
<em>component</em>: Totem component that generated the event (orchestrator, deployer).</li>
<li>
<em>meta-info</em>: Meta info associated with the event. Typically it comprises of git meta-data and job identifier.</li>
<li>
<em>details</em>: The detailed json object describing the event.</li>
</ul>

<h1>
<a id="totem-config-guide" class="anchor" href="#totem-config-guide" aria-hidden="true"><span class="octicon octicon-link"></span></a>Totem Config Guide</h1>

<h2>
<a id="about" class="anchor" href="#about" aria-hidden="true"><span class="octicon octicon-link"></span></a>About</h2>

<p>This guide covers the basics of totem configuration file used per deployed application in totem.</p>

<h2>
<a id="supported-formats" class="anchor" href="#supported-formats" aria-hidden="true"><span class="octicon octicon-link"></span></a>Supported Formats</h2>

<p>Currently <a href="http://yaml.org/">YAML</a> is the only supported configuration format used in totem.</p>

<h2>
<a id="config-names" class="anchor" href="#config-names" aria-hidden="true"><span class="octicon octicon-link"></span></a>Config Names</h2>

<p>The totem configuration file names can be be configured during orchestrator provisioning. By default following names
are used:</p>

<ul>
<li>
<strong>cluster-def.yml</strong> : Typically used at global level to define cluster definition.</li>
<li>
<strong>totem.yml</strong>: Typically used at global/application level for defining rest of config.<br>
<em>Note: You may break the config into multiple files if needed. In the end , all configs are merged into a single file
during deployment</em>
</li>
</ul>

<h2>
<a id="config-location" class="anchor" href="#config-location" aria-hidden="true"><span class="octicon octicon-link"></span></a>Config Location</h2>

<p>The config can be stored in one or more locations defined by env. variable <strong>CONFIG_PROVIDER_LIST</strong> in orchestrator.
<em>Note: If using AWS, typical approach is to store config in Amazon S3. CONFIG_PROVIDER_LIST=s3</em>
All except (default and github) provider support multi level config where in the config file can be defined:</p>

<ul>
<li>Globally (for all environments ) at path: <strong>/totem/config</strong>
</li>
<li>Per environment at path: <strong>/totem/config/[env-name]</strong>  e.g.:  /totem/config/production</li>
<li>Per Repository owner at path: <strong>/totem/config/[env-name]/[repo-owner]</strong> e.g.: /totem/config/production/totem</li>
<li>Per Repository at path: <strong>/totem/config/[env-name]/[repo-owner]/[repository]</strong>
e.g.: /totem/config/production/totem/totem-demo</li>
<li>Per Repository branch or tag: <strong>/totem/config/[env-name]/[repo-owner]/[repository]/[ref]</strong>
e.g.: /totem/config/production/totem/totem-demo/develop</li>
</ul>

<h2>
<a id="config-merge" class="anchor" href="#config-merge" aria-hidden="true"><span class="octicon octicon-link"></span></a>Config Merge</h2>

<p>During a deploy, all configs (multiple files, multiple locations) are merged into a single config that typically
gets cached in etcd store. The merge is performed using nested merge strategy with config keys defined at branch
or tag level takes the highest precendence while the one defined globally takes the lowest precendence. In addition
if multiple config providers are defined e.g. (etcd,s3,default), the provider occuring first takes precendence over
the one occuring later.</p>

<p>e.g. Given 2 configs:</p>

<div class="highlight highlight-yaml"><pre><span class="pl-s"><span class="pl-ent">deployer:</span></span>
  <span class="pl-s"><span class="pl-ent">deployer1:</span></span>
    <span class="pl-s"><span class="pl-ent">enabled:</span> <span class="pl-s">true</span></span>
  <span class="pl-s"><span class="pl-ent">deployer2:</span></span>
    <span class="pl-s"><span class="pl-ent">enabled:</span> <span class="pl-s">false</span></span></pre></div>

<div class="highlight highlight-yaml"><pre><span class="pl-s"><span class="pl-ent">deployer:</span></span>
  <span class="pl-s"><span class="pl-ent">deployer1:</span></span>
    <span class="pl-s"><span class="pl-ent">enabled:</span> <span class="pl-s">false</span></span>
  <span class="pl-s"><span class="pl-ent">deployer3:</span></span>
    <span class="pl-s"><span class="pl-ent">enabled:</span> <span class="pl-s">true</span></span></pre></div>

<p>When we merge the 2 configs, the resulting config looks like:</p>

<div class="highlight highlight-yaml"><pre><span class="pl-s"><span class="pl-ent">deployer:</span></span>
  <span class="pl-s"><span class="pl-ent">deployer1:</span></span>
    <span class="pl-s"><span class="pl-ent">enabled:</span> <span class="pl-s">true</span></span>
  <span class="pl-s"><span class="pl-ent">deployer2:</span></span>
    <span class="pl-s"><span class="pl-ent">enabled:</span> <span class="pl-s">true</span></span>
  <span class="pl-s"><span class="pl-ent">deployer3:</span></span>
    <span class="pl-s"><span class="pl-ent">enabled:</span> <span class="pl-s">true</span></span></pre></div>

<h2>
<a id="encrypted-values" class="anchor" href="#encrypted-values" aria-hidden="true"><span class="octicon octicon-link"></span></a>Encrypted Values</h2>

<p>Some sections of totem config can contain encrypted values. It uses asymmetric cryptography using PKCS#1 v1.5. Refer to <a href="https://github.com/totem/cluster-deployer">cluster-deployer</a> guide to enable encryption for a given cluster.
The cluster deployer uses different profiles for encryption. See <a href="#security">Config Schema - Security Section</a> for defining a security profile. The name of default profile is 'default'.</p>

<p>If a given config supports encryption, set encrypted property for the config element to true.
e.g.: </p>

<pre><code>deployers:
  default:
    templates:
      app:
        args:
          environment:
            AWS_SECRET_ACCESS_KEY:
              value: "*****encrypted value******"
              encrypted: true
</code></pre>

<p>In this example, the environment variable "AWS_SECRET_ACCESS_KEY" is injected into the application and its value is marked as injected. The value is decrypted at the final stage of deploy when fleet unit file is created.</p>

<h2>
<a id="config-schema" class="anchor" href="#config-schema" aria-hidden="true"><span class="octicon octicon-link"></span></a>Config Schema</h2>

<p>Totem config is validated using <a href="http://json-schema.org/">json schema</a>. Currently there are 2 schemas defined for validation:</p>

<ul>
<li>
<a href="https://github.com/totem/cluster-orchestrator/blob/master/schemas/job-config-v1.json">job-config-v1.json</a>: This schema corresponds to first step in validation phase. This step is applied after all configs are merged to create a single config.</li>
<li>
<a href="https://github.com/totem/cluster-orchestrator/blob/master/schemas/job-config-v1-evaluated.json">job-config-evaluated-v1.json</a>: This schema corresponds to second step in validation phase. This step is applied after dynamic portions of configs are evaluated.</li>
</ul>

<h2>
<a id="config-elements" class="anchor" href="#config-elements" aria-hidden="true"><span class="octicon octicon-link"></span></a>Config Elements</h2>

<h3>
<a id="variables" class="anchor" href="#variables" aria-hidden="true"><span class="octicon octicon-link"></span></a>variables</h3>

<h4>
<a id="variables-overview" class="anchor" href="#variables-overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Variables Overview</h4>

<p>Defines the dynamic values that gets substituted in dynamic section of a given config. Basically it acts as variables for jinja substitution. Refer dynamic section for more details.
e.g.:</p>

<div class="highlight highlight-yaml"><pre><span class="pl-s"><span class="pl-ent">variables:</span></span>
  <span class="pl-s"><span class="pl-ent">public_host:</span> <span class="pl-s">myapp.myhost.com</span></span>

<span class="pl-s"><span class="pl-ent">proxy:</span></span>
  <span class="pl-s"><span class="pl-ent">hosts:</span></span>
    <span class="pl-s"><span class="pl-ent">public:</span></span>
      <span class="pl-s"><span class="pl-ent">hostname:</span></span>
        <span class="pl-s"><span class="pl-ent">value:</span> <span class="pl-s"><span class="pl-pds">"</span>{{public_host}}<span class="pl-pds">"</span></span></span></pre></div>

<p>In this example, the value of hostname is substituted by myapp.myhost.com when config is evaluated.</p>

<h4>
<a id="templated-variables" class="anchor" href="#templated-variables" aria-hidden="true"><span class="octicon octicon-link"></span></a>Templated variables</h4>

<p>The variables values itself can be evaluated dynamically using jinja templates. The variables are evaluated in order defined by their priority (Variables with lower priority are evaluated first).
e.g.:</p>

<div class="highlight highlight-yaml"><pre><span class="pl-s"><span class="pl-ent">variables:</span></span>
  <span class="pl-s"><span class="pl-ent">private_host:</span> <span class="pl-s">myapp.myhost.com</span></span>
  <span class="pl-s"><span class="pl-ent">public_host:</span></span>
    <span class="pl-s"><span class="pl-ent">value:</span> <span class="pl-s"><span class="pl-pds">"</span>{{public_host}}<span class="pl-pds">"</span></span></span>
    <span class="pl-c1"><span class="pl-ent">priority:</span> 2</span></pre></div>

<p>In this example the value of variable public_host is evaluated using the value of private_host.</p>

<h3>
<a id="security" class="anchor" href="#security" aria-hidden="true"><span class="octicon octicon-link"></span></a>security</h3>

<p>This section defines the security settings to be used globally or per application. By default, a 'default' security profile is defined. e.g.:</p>

<div class="highlight highlight-yaml"><pre><span class="pl-s"><span class="pl-ent">security:</span></span>
  <span class="pl-s"><span class="pl-ent">profile:</span> <span class="pl-s">myapp</span></span></pre></div>

<p>In the above example security profile is changed from 'default' to 'myapp'.  Refer <a href="README.md#encrypted-values">Encrypted Values</a> section to kno more about encryption.</p>

<h3>
<a id="deployers" class="anchor" href="#deployers" aria-hidden="true"><span class="octicon octicon-link"></span></a>deployers</h3>

<p>This section defines one or more deployer definition.  Each deployer definition consists of different settings to be used for deploying given application and url of the deployer. Typically, the urls can be defined in separate totem file (cluster-def.yml), while the applications specific settings can be added in totem.yml file.</p>

<h3>
<a id="hooks" class="anchor" href="#hooks" aria-hidden="true"><span class="octicon octicon-link"></span></a>hooks</h3>

<p>This section defines one or more hooks that is being enabled for the given application. The hooks may be a CI hook or builder hook.</p>

<h3>
<a id="notifications" class="anchor" href="#notifications" aria-hidden="true"><span class="octicon octicon-link"></span></a>notifications</h3>

<p>This section define one or more notifiers (e.g: github, hipchat) to be used for given application to send success/failed notifications.</p>
      </section>
      <footer>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>